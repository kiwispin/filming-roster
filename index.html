<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berkley TV - Technical Team Scheduler</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f1117;
            --bg-surface: #161820;
            --card-bg: #1c1e28;
            --slot-bg: #1f2230;
            --border-color: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(255, 255, 255, 0.12);
            --text-primary: #eaedf3;
            --text-secondary: #7a7f96;
            --text-dim: #4a4e63;
            --accent: #6c8aff;
            --accent-glow: rgba(108, 138, 255, 0.15);
            --success: #34d399;
            --success-glow: rgba(52, 211, 153, 0.15);
            --warning: #fbbf24;
            --danger: #f87171;
            --danger-glow: rgba(248, 113, 113, 0.1);
            --pill-bg: #339af0;
            --trash-bg: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg-color);
            background-image:
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(108, 138, 255, 0.07), transparent),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(108, 138, 255, 0.03), transparent);
            color: var(--text-primary);
            margin: 0;
            padding: 24px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* === SCROLLBAR === */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* === HEADER === */
        .app-header {
            margin: 0 0 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-title h1 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, #eaedf3, #9ba3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .app-logo {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, rgba(108, 138, 255, 0.15), rgba(108, 138, 255, 0.05));
            border-radius: 10px;
            border: 1px solid rgba(108, 138, 255, 0.2);
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* === BUTTONS === */
        button {
            font-family: 'Inter', sans-serif;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.78rem;
            font-weight: 500;
            letter-spacing: 0.01em;
            transition: all 0.2s ease;
        }

        button:hover {
            background: var(--slot-bg);
            border-color: var(--border-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button.primary {
            background: linear-gradient(135deg, #6c8aff, #5a6fd6);
            color: white;
            border: none;
            box-shadow: 0 2px 12px rgba(108, 138, 255, 0.2);
        }

        button.primary:hover {
            box-shadow: 0 4px 20px rgba(108, 138, 255, 0.35);
        }

        button.danger {
            color: var(--danger);
            border-color: rgba(248, 113, 113, 0.2);
        }

        button.danger:hover {
            background: var(--danger-glow);
            border-color: rgba(248, 113, 113, 0.35);
        }

        /* === INSTRUCTIONS === */
        .instructions {
            background: rgba(28, 30, 40, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 0.76rem;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            align-items: center;
            gap: 24px;
            flex-shrink: 0;
            line-height: 1.5;
        }

        .instruction-line {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .key-action {
            background: rgba(108, 138, 255, 0.1);
            color: var(--accent);
            padding: 2px 8px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.72rem;
            letter-spacing: 0.02em;
        }

        /* === MAIN LAYOUT === */
        .main-layout {
            display: flex;
            flex: 1;
            gap: 16px;
            min-height: 0;
        }

        /* === SIDEBAR (Team Pool) === */
        .student-pool {
            width: 190px;
            min-width: 190px;
            background: rgba(28, 30, 40, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            padding: 16px 12px;
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .student-pool.drag-over-delete {
            background: rgba(239, 68, 68, 0.08);
            border-color: rgba(239, 68, 68, 0.3);
            box-shadow: inset 0 0 40px rgba(239, 68, 68, 0.04);
        }

        .student-pool.drag-over-delete::after {
            content: "‚Ü© Drop to remove";
            display: block;
            text-align: center;
            color: var(--danger);
            font-weight: 600;
            font-size: 0.72rem;
            margin-top: 8px;
            letter-spacing: 0.04em;
        }

        .pool-label {
            font-weight: 700;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-align: center;
            display: block;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.12em;
        }

        /* === SCHEDULE AREA === */
        .schedule-container {
            flex: 1;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 32px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.03);
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 110px repeat(5, 1fr);
            min-width: 800px;
            flex-grow: 1;
        }

        /* === PILLS === */
        .student-pill {
            background-color: var(--pill-bg);
            color: white;
            border-radius: 8px;
            font-size: 0.82rem;
            font-weight: 500;
            cursor: grab;
            user-select: none;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.2s cubic-bezier(0.22, 1, 0.36, 1);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .student-pool .student-pill {
            width: 100%;
            height: 38px;
            justify-content: center;
            font-weight: 600;
            font-size: 0.82rem;
            letter-spacing: 0.01em;
        }

        .student-pool .student-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .student-pill:active {
            cursor: grabbing;
            transform: scale(0.96);
        }

        .grid-cell .student-pill {
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 8px;
            display: inline-flex;
            width: 160px;
            box-sizing: border-box;
            justify-content: space-between;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .grid-cell .student-pill:hover {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.15), 0 6px 16px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px);
        }

        .pill-content {
            display: flex;
            align-items: center;
            gap: 6px;
            overflow: hidden;
            white-space: nowrap;
        }

        /* === STATUS BUTTON (Checkbox) === */
        .status-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.25);
            font-size: 10px;
            cursor: pointer;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
            transition: all 0.2s ease;
            color: transparent;
        }

        .status-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .status-btn.done {
            background: #fff;
            color: var(--success);
            border-color: #fff;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(52, 211, 153, 0.3);
        }

        /* Done State for whole pill */
        .student-pill.pill-done {
            background: #166534 !important;
            opacity: 0.7;
            border-color: rgba(52, 211, 153, 0.3);
        }

        .pill-done .pill-content span:not(.status-btn) {
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* === PILL COLORS (gradient palette) === */
        .pill-isla {
            background: linear-gradient(135deg, #ec4899, #db2777);
        }

        .pill-chenuthi {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .pill-tobin {
            background: linear-gradient(135deg, #c084fc, #a855f7);
        }

        .pill-jacey {
            background: linear-gradient(135deg, #34d399, #10b981);
            color: #064e3b;
        }

        .pill-amelia {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
        }

        .pill-seoyeon {
            background: linear-gradient(135deg, #fb923c, #f97316);
            color: #431407;
        }

        .pill-alice {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #451a03;
        }

        .pill-hunter {
            background: linear-gradient(135deg, #a3e635, #84cc16);
            color: #1a2e05;
        }

        .pill-kanin {
            background: linear-gradient(135deg, #2dd4bf, #14b8a6);
            color: #042f2e;
        }

        .pill-faith {
            background: linear-gradient(135deg, #fcd34d, #eab308);
            color: #422006;
        }

        .equipment-icon {
            font-size: 1em;
        }

        /* === EDIT NOTE BUTTON === */
        .edit-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            opacity: 0.45;
            flex-shrink: 0;
            margin-left: 4px;
            color: white;
            transition: all 0.2s;
        }

        .edit-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            opacity: 1;
        }

        .edit-btn.has-note {
            color: var(--warning);
            opacity: 1;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
        }

        /* === GRID STRUCTURE === */
        .header-cell {
            background: var(--bg-surface);
            padding: 14px 12px;
            text-align: center;
            font-weight: 700;
            font-size: 0.8rem;
            letter-spacing: 0.03em;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .time-label {
            background: var(--bg-surface);
            padding: 10px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.72rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            position: sticky;
            left: 0;
            z-index: 5;
            letter-spacing: 0.01em;
        }

        .grid-cell {
            background: var(--slot-bg);
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            min-height: 80px;
            padding: 8px;
            display: block;
            transition: all 0.2s ease;
        }

        .grid-cell:hover {
            background: rgba(108, 138, 255, 0.03);
        }

        .grid-cell.drag-over {
            background: rgba(108, 138, 255, 0.06);
            box-shadow: inset 0 0 0 2px rgba(108, 138, 255, 0.35);
        }

        .row-break {
            background: rgba(0, 0, 0, 0.12);
        }

        /* === CLOUD STATUS === */
        .cloud-status {
            font-size: 0.68rem;
            font-weight: 600;
            color: var(--text-dim);
            padding: 4px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border-color);
            letter-spacing: 0.03em;
            transition: all 0.3s ease;
            margin-left: 4px;
        }

        /* === ANIMATIONS === */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .student-pill {
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }
    </style>
</head>

<body>

    <div class="app-header">
        <div class="app-title">
            <div class="app-logo">üé•</div>
            <h1>Technical Team Roster</h1>
            <span id="cloudStatus" class="cloud-status"></span>
        </div>
        <div class="controls">
            <button onclick="resetToDefault()">Reset to Week 3 Plan</button>
            <button class="danger" onclick="clearSchedule()">Clear All</button>
        </div>
    </div>

    <div class="instructions">
        <div class="instruction-line">
            <span class="key-action">Click Circle ‚óã</span> to mark Done (‚úì).
            <span class="key-action">Click Name/Icon</span> to cycle equipment: &nbsp; üé• &nbsp;‚Üí&nbsp; üì± &nbsp;‚Üí&nbsp;
            üöÅ.
        </div>
        <div class="instruction-line">
            <span class="key-action">Click Pencil ‚úé</span> to add notes. Hover to view.
            To remove, drag back to sidebar.
        </div>
    </div>

    <!-- Main Layout: Grid on Left, Sidebar on Right -->
    <div class="main-layout">

        <div class="schedule-container">
            <div class="schedule-grid" id="scheduleGrid">
                <!-- Grid generated by JS -->
            </div>
        </div>

        <div class="student-pool" id="studentPool">
            <span class="pool-label">Team Members</span>
            <!-- Students will be generated here by JS -->
        </div>

    </div>

    <script type="module">
        // --- Firebase Imports & Setup ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBiiOEfUnRY5tWZX8mSyvFAwnLLsK9QhH8",
            authDomain: "dji-drop-studio.firebaseapp.com",
            projectId: "dji-drop-studio",
            storageBucket: "dji-drop-studio.firebasestorage.app",
            messagingSenderId: "566870188844",
            appId: "1:566870188844:web:81ce637d5c2e92fc7e4289"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'filming-roster-berkley';

        // --- Data Configuration ---
        const students = [
            { id: 'isla', name: 'Isla', color: 'pill-isla' },
            { id: 'chenuthi', name: 'Chenuthi', color: 'pill-chenuthi' },
            { id: 'tobin', name: 'Tobin', color: 'pill-tobin' },
            { id: 'jacey', name: 'Jacey', color: 'pill-jacey' },
            { id: 'amelia', name: 'Amelia', color: 'pill-amelia' },
            { id: 'seoyeon', name: 'Seoyeon', color: 'pill-seoyeon' },
            { id: 'alice', name: 'Alice', color: 'pill-alice' },
            { id: 'hunter', name: 'Hunter', color: 'pill-hunter' },
            { id: 'kanin', name: 'Kanin', color: 'pill-kanin' },
            { id: 'faith', name: 'Faith', color: 'pill-faith' },
        ];

        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

        const timeSlots = [
            { id: 'before', label: 'Before School' },
            { id: 'block1', label: 'Block 1' },
            { id: 'break1', label: 'Break 1' },
            { id: 'block2', label: 'Block 2' },
            { id: 'break2', label: 'Break 2' },
            { id: 'block3', label: 'Block 3' },
            { id: 'lunch', label: 'Lunch' },
            { id: 'block4', label: 'Block 4' },
            { id: 'after', label: 'After School' }
        ];

        const equipmentIcons = {
            'camera': 'üé•',
            'phone': 'üì±',
            'drone': 'üöÅ',
            'none': ''
        };

        const equipmentOrder = ['none', 'camera', 'phone', 'drone'];

        // State
        let currentState = {};
        let currentEquipment = {};
        let completionState = {};
        let notesState = {}; // New: { "cellId-studentId": "note text" }

        // Default Roster Logic
        const recommendedState = {
            'Monday-before': ['isla', 'jacey', 'chenuthi'],
            'Monday-break1': ['hunter'],
            'Monday-break2': ['kanin'],
            'Monday-lunch': ['faith'],
            'Monday-after': ['isla', 'chenuthi', 'tobin'],

            'Tuesday-before': ['amelia', 'isla', 'tobin'],
            'Tuesday-break1': ['kanin'],
            'Tuesday-break2': ['faith'],
            'Tuesday-lunch': ['hunter'],
            'Tuesday-after': ['alice', 'chenuthi'],

            // Wednesday AM fixed to 3 people max
            'Wednesday-before': ['seoyeon', 'jacey', 'alice'],
            'Wednesday-break1': ['faith'],
            'Wednesday-break2': ['hunter'],
            'Wednesday-lunch': ['kanin'],
            'Wednesday-after': ['chenuthi'],

            'Thursday-before': ['seoyeon', 'isla', 'amelia'],
            'Thursday-break1': ['hunter'],
            'Thursday-break2': ['kanin'],
            'Thursday-lunch': ['faith'],
            'Thursday-after': ['amelia', 'alice', 'tobin'],

            'Friday-before': ['jacey', 'amelia', 'chenuthi'],
            'Friday-break1': ['kanin'],
            'Friday-break2': ['faith'],
            'Friday-lunch': ['hunter'],
            'Friday-after': ['amelia', 'alice', 'tobin']
        };

        // FULL WEEK 3 EQUIPMENT ROTATION (ALL ASSIGNED)
        const recommendedEquipment = {
            // Monday
            'Monday-before-isla': 'phone',
            'Monday-before-jacey': 'camera',
            'Monday-before-chenuthi': 'drone',
            'Monday-break1-hunter': 'phone',
            'Monday-break2-kanin': 'camera',
            'Monday-lunch-faith': 'phone',
            'Monday-after-isla': 'camera',
            'Monday-after-chenuthi': 'drone',
            'Monday-after-tobin': 'phone',

            // Tuesday
            'Tuesday-before-amelia': 'phone',
            'Tuesday-before-isla': 'camera',
            'Tuesday-before-tobin': 'drone',
            'Tuesday-break1-kanin': 'phone',
            'Tuesday-break2-faith': 'camera',
            'Tuesday-lunch-hunter': 'drone',
            'Tuesday-after-alice': 'phone',
            'Tuesday-after-chenuthi': 'camera',

            // Wednesday
            'Wednesday-before-seoyeon': 'drone',
            'Wednesday-before-alice': 'camera',
            'Wednesday-before-jacey': 'phone',
            'Wednesday-break1-faith': 'camera',
            'Wednesday-break2-hunter': 'phone',
            'Wednesday-lunch-kanin': 'camera',
            'Wednesday-after-chenuthi': 'phone',

            // Thursday
            'Thursday-before-seoyeon': 'phone',
            'Thursday-before-isla': 'drone',
            'Thursday-before-amelia': 'camera',
            'Thursday-break1-hunter': 'camera',
            'Thursday-break2-kanin': 'phone',
            'Thursday-lunch-faith': 'drone',
            'Thursday-after-amelia': 'drone',
            'Thursday-after-alice': 'phone',
            'Thursday-after-tobin': 'camera',

            // Friday
            'Friday-before-jacey': 'drone',
            'Friday-before-amelia': 'phone',
            'Friday-before-chenuthi': 'camera',
            'Friday-break1-kanin': 'drone',
            'Friday-break2-faith': 'phone',
            'Friday-lunch-hunter': 'camera',
            'Friday-after-amelia': 'camera',
            'Friday-after-alice': 'drone',
            'Friday-after-tobin': 'phone'
        };

        // --- Initialization ---

        async function init() {
            renderStudentPool();
            renderGrid();
            setupPoolDrop();

            // Expose functions globally for HTML onclick handlers
            window.resetToDefault = resetToDefault;
            window.clearSchedule = clearSchedule;

            // Cloud Auth
            document.getElementById('cloudStatus').textContent = "Connecting...";

            try {
                await signInAnonymously(auth);

                // Connect to Live DB
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster_data', 'week3');
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentState = data.currentState || {};
                        currentEquipment = data.currentEquipment || {};
                        completionState = data.completionState || {};
                        notesState = data.notesState || {};
                        updateGridDisplay();
                        document.getElementById('cloudStatus').textContent = "‚òÅÔ∏è Live";
                    } else {
                        // First time? Save default state to DB
                        document.getElementById('cloudStatus').textContent = "Initializing...";
                        resetToDefault(true);
                    }
                }, (error) => {
                    console.error("Sync error:", error);
                    document.getElementById('cloudStatus').textContent = "‚ö†Ô∏è Sync Error";
                });

            } catch (e) {
                console.error("Auth error:", e);
                document.getElementById('cloudStatus').textContent = "‚ö†Ô∏è Offline";
            }
        }

        // --- Rendering ---

        function renderStudentPool() {
            const pool = document.getElementById('studentPool');
            pool.innerHTML = '<span class="pool-label">Team Members</span>';

            students.forEach(student => {
                const pill = createPill(student, 'pool');
                pool.appendChild(pill);
            });
        }

        function createPill(student, origin, cellId) {
            const pill = document.createElement('div');
            pill.className = `student-pill ${student.color}`;
            pill.draggable = true;
            pill.dataset.studentId = student.id;

            // Use a structure that allows separation in the grid
            if (origin === 'grid') {
                const content = document.createElement('div');
                content.className = 'pill-content';

                const noteKey = `${cellId}-${student.id}`;
                // If there's a note, set tooltip
                if (notesState[noteKey]) {
                    pill.title = notesState[noteKey];
                } else {
                    pill.title = "";
                }

                // 1. Completion Checkbox
                const statusKey = `${cellId}-${student.id}`;
                const isDone = completionState[statusKey] || false;

                if (isDone) {
                    pill.classList.add('pill-done');
                }

                const checkBtn = document.createElement('span');
                checkBtn.className = isDone ? 'status-btn done' : 'status-btn';
                checkBtn.innerHTML = isDone ? '‚úì' : '‚óã';
                checkBtn.onclick = (e) => {
                    e.stopPropagation(); // Stop bubble so we don't toggle equipment
                    toggleCompletion(cellId, student.id);
                };
                content.appendChild(checkBtn);

                // 2. Equipment Icon
                const equipKey = `${cellId}-${student.id}`;
                const equip = currentEquipment[equipKey] || 'none';
                if (equip !== 'none') {
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'equipment-icon';
                    iconSpan.textContent = equipmentIcons[equip];
                    content.appendChild(iconSpan);
                }

                // 3. Name
                const nameSpan = document.createElement('span');
                nameSpan.textContent = student.name;
                content.appendChild(nameSpan);

                pill.appendChild(content);

                // 4. Edit Note Button (Pencil)
                const editBtn = document.createElement('span');
                editBtn.className = 'edit-btn';
                if (notesState[noteKey]) {
                    editBtn.classList.add('has-note'); // Visual indicator
                }
                editBtn.innerHTML = '‚úé';
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    editNote(cellId, student.id);
                };
                pill.appendChild(editBtn);

                // Click Pill Body -> Toggle Equipment
                pill.onclick = (e) => {
                    // If we clicked edit or status, don't cycle
                    if (e.target.classList.contains('edit-btn')) return;
                    if (e.target.classList.contains('status-btn')) return;
                    toggleEquipment(cellId, student.id);
                };
            } else {
                // Sidebar simple structure
                pill.textContent = student.name;
            }

            // Drag Events
            pill.addEventListener('dragstart', handleDragStart);

            return pill;
        }

        function renderGrid() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';

            const corner = document.createElement('div');
            corner.className = 'header-cell';
            grid.appendChild(corner);

            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'header-cell';
                header.textContent = day;
                grid.appendChild(header);
            });

            timeSlots.forEach(slot => {
                const label = document.createElement('div');
                label.className = 'time-label';
                label.textContent = slot.label;
                grid.appendChild(label);

                days.forEach(day => {
                    const cellId = `${day}-${slot.id}`;
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    if (slot.id.includes('break') || slot.id === 'lunch') {
                        cell.classList.add('row-break');
                    }
                    cell.id = cellId;

                    cell.addEventListener('dragover', handleDragOver);
                    cell.addEventListener('dragleave', handleDragLeave);
                    cell.addEventListener('drop', handleDrop);

                    grid.appendChild(cell);
                });
            });
        }

        function updateGridDisplay() {
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.innerHTML = '';
            });

            for (const [cellId, studentIds] of Object.entries(currentState)) {
                const cell = document.getElementById(cellId);
                if (cell && Array.isArray(studentIds)) {
                    studentIds.forEach(studentId => {
                        const student = students.find(s => s.id === studentId);
                        if (student) {
                            cell.appendChild(createPill(student, 'grid', cellId));
                        }
                    });
                }
            }
        }

        // --- Logic ---

        function toggleEquipment(cellId, studentId) {
            const key = `${cellId}-${studentId}`;
            const current = currentEquipment[key] || 'none';

            let nextIndex = equipmentOrder.indexOf(current) + 1;
            if (nextIndex >= equipmentOrder.length) nextIndex = 0;

            const next = equipmentOrder[nextIndex];

            if (next === 'none') {
                delete currentEquipment[key];
            } else {
                currentEquipment[key] = next;
            }

            saveState();
            updateGridDisplay();
        }

        function toggleCompletion(cellId, studentId) {
            const key = `${cellId}-${studentId}`;
            const current = completionState[key] || false;

            if (current) {
                delete completionState[key];
            } else {
                completionState[key] = true;
            }

            saveState();
            updateGridDisplay();
        }

        function editNote(cellId, studentId) {
            const key = `${cellId}-${studentId}`;
            const currentNote = notesState[key] || "";
            const newNote = prompt("Enter specific filming notes (e.g. 'Film math class'):", currentNote);

            if (newNote !== null) {
                if (newNote.trim() === "") {
                    delete notesState[key];
                } else {
                    notesState[key] = newNote.trim();
                }
                saveState();
                updateGridDisplay();
            }
        }

        // --- Drag and Drop Logic ---

        let draggedStudentId = null;
        let sourceCellId = null;

        function handleDragStart(e) {
            draggedStudentId = e.target.dataset.studentId;
            if (e.target.parentElement.classList.contains('grid-cell')) {
                sourceCellId = e.target.parentElement.id;
            } else {
                sourceCellId = null;
            }
            e.dataTransfer.effectAllowed = 'copyMove';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const targetCell = e.currentTarget;
            targetCell.classList.remove('drag-over');
            const targetCellId = targetCell.id;

            if (!draggedStudentId) return;
            if (sourceCellId === targetCellId) return;

            // Limit Check
            if (currentState[targetCellId] && currentState[targetCellId].length >= 3) {
                alert("Maximum 3 team members allowed per slot!");
                return;
            }

            if (sourceCellId) {
                // Preserve metadata before removing from old slot
                const oldKey = `${sourceCellId}-${draggedStudentId}`;
                const savedEquip = currentEquipment[oldKey];
                const savedDone = completionState[oldKey];
                const savedNote = notesState[oldKey];

                removeStudentFromSlot(sourceCellId, draggedStudentId);
                addStudentToSlot(targetCellId, draggedStudentId);

                // Restore metadata under the new cell key
                const newKey = `${targetCellId}-${draggedStudentId}`;
                if (savedEquip) currentEquipment[newKey] = savedEquip;
                if (savedDone) completionState[newKey] = savedDone;
                if (savedNote) notesState[newKey] = savedNote;

                saveState();
                updateGridDisplay();
            } else {
                addStudentToSlot(targetCellId, draggedStudentId);
            }
        }

        // --- Sidebar Drop to Delete Logic ---

        function setupPoolDrop() {
            const pool = document.getElementById('studentPool');

            pool.addEventListener('dragover', (e) => {
                e.preventDefault();
                // Only show delete cue if dragging from grid
                if (sourceCellId) {
                    pool.classList.add('drag-over-delete');
                }
            });

            pool.addEventListener('dragleave', (e) => {
                pool.classList.remove('drag-over-delete');
            });

            pool.addEventListener('drop', (e) => {
                e.preventDefault();
                pool.classList.remove('drag-over-delete');

                // Only perform delete if coming from grid
                if (sourceCellId && draggedStudentId) {
                    removeStudentFromSlot(sourceCellId, draggedStudentId);
                }
            });
        }


        // --- State Management ---

        function addStudentToSlot(cellId, studentId) {
            if (!currentState[cellId]) {
                currentState[cellId] = [];
            }
            if (!currentState[cellId].includes(studentId)) {
                currentState[cellId].push(studentId);
            }
            saveState();
            updateGridDisplay();
        }

        function removeStudentFromSlot(cellId, studentId) {
            if (currentState[cellId]) {
                currentState[cellId] = currentState[cellId].filter(id => id !== studentId);
                if (currentState[cellId].length === 0) {
                    delete currentState[cellId];
                }
                delete currentEquipment[`${cellId}-${studentId}`];
                delete completionState[`${cellId}-${studentId}`];
                delete notesState[`${cellId}-${studentId}`];

                saveState();
                updateGridDisplay();
            }
        }

        function saveState() {
            // Save to Firebase instead of LocalStorage
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'roster_data', 'week3');
            setDoc(docRef, {
                currentState,
                currentEquipment,
                completionState,
                notesState
            });
        }

        function clearSchedule() {
            const pin = prompt("Enter PIN to clear schedule:");
            if (pin === "2626") {
                if (confirm("Are you sure you want to clear the entire schedule?")) {
                    currentState = {};
                    currentEquipment = {};
                    completionState = {};
                    notesState = {};
                    saveState();
                    updateGridDisplay();
                }
            } else if (pin !== null) {
                alert("Incorrect PIN");
            }
        }

        function resetToDefault(skipConfirm = false) {
            if (skipConfirm) {
                currentState = JSON.parse(JSON.stringify(recommendedState));
                currentEquipment = JSON.parse(JSON.stringify(recommendedEquipment));
                completionState = {};
                notesState = {};
                saveState();
                updateGridDisplay();
                return;
            }

            const pin = prompt("Enter PIN to reset schedule:");
            if (pin === "2626") {
                if (confirm("Reset to the Week 3 Plan? This will overwrite your changes.")) {
                    currentState = JSON.parse(JSON.stringify(recommendedState));
                    currentEquipment = JSON.parse(JSON.stringify(recommendedEquipment));
                    completionState = {};
                    notesState = {};
                    saveState();
                    updateGridDisplay();
                }
            } else if (pin !== null) {
                alert("Incorrect PIN");
            }
        }

        // Run
        init();

    </script>
</body>

</html>